<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solvoro — Edit Profile</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f7f7f7;
      --card-bg: #ffffff;
      --border: #e5e5e5;
      --text-main: #111111;
      --text-muted: #666666;
      --accent: #111111;
      --shadow-soft: 0 12px 40px rgba(0,0,0,0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .top-bar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      padding: 10px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-left img {
      height: 28px;
      width: auto;
    }

    .brand-name {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .top-link {
      font-size: 14px;
      color: var(--text-muted);
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      transition: background 0.16s ease, border-color 0.16s ease, color 0.16s ease;
    }

    .top-link:hover {
      border-color: var(--border);
      background: #f2f2f2;
      color: var(--text-main);
    }

    .avatar-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #111111;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .page-wrap {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 20px 12px 32px;
    }

    .edit-shell {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 18px;
      animation: floatIn 0.35s ease-out;
    }

    @media (max-width: 768px) {
      .edit-shell {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-soft);
      padding: 20px 18px;
      border: 1px solid rgba(0,0,0,0.03);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    .profile-snap {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .profile-avatar-large {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #111111;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .profile-snap-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .profile-snap-name {
      font-size: 16px;
      font-weight: 500;
    }

    form {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 16px;
    }

    @media (max-width: 640px) {
      form {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    label span {
      color: #c62828;
    }

    input, textarea {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 9px 10px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      background: #ffffff;
      transition: border-color 0.16s ease, box-shadow 0.16s ease;
    }

    input:focus, textarea:focus {
      border-color: #111111;
      box-shadow: 0 0 0 1px #11111111;
    }

    input[readonly] {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .col-span-2 {
      grid-column: span 2;
    }

    @media (max-width: 640px) {
      .col-span-2 {
        grid-column: span 1;
      }
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .button-row {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-solid {
      padding: 9px 18px;
      border-radius: 999px;
      border: 1px solid #111111;
      background: #111111;
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.16s ease, transform 0.06s ease;
    }

    .btn-solid:hover {
      background: #000000;
      transform: translateY(-1px);
    }

    .btn-outline {
      padding: 9px 18px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.16s ease, border-color 0.16s ease;
    }

    .btn-outline:hover {
      background: #f3f3f3;
      border-color: #d4d4d4;
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .status.error {
      color: #c62828;
    }

    .status.success {
      color: #2e7d32;
    }

    .side-info {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .side-info-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    @keyframes floatIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    footer {
      text-align: center;
      font-size: 11px;
      color: #a3a3a3;
      padding: 10px 0 18px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="top-bar">
    <div class="top-left">
      <img src="logo.png" alt="Solvoro Logo">
      <span class="brand-name">SOLVORO</span>
    </div>
    <div class="top-right">
      <a href="dashboard-home.html" class="top-link">Home</a>
      <a href="services.html" class="top-link">Services</a>
      <a href="profile.html" class="top-link">Profile</a>
      <div id="headerAvatar" class="avatar-circle">S</div>
    </div>
  </header>

  <!-- Main -->
  <div class="page-wrap">
    <div class="edit-shell">
      <!-- Edit card -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Edit profile</div>
            <div class="card-sub">Keep your information up to date</div>
          </div>
        </div>

        <div class="profile-snap">
          <div id="profileAvatar" class="profile-avatar-large">S</div>
          <div class="profile-snap-text">
            <div id="snapName" class="profile-snap-name">Loading...</div>
            <div id="snapMail" class="hint"></div>
          </div>
        </div>

        <form id="profileForm">
          <!-- Name -->
          <div class="field col-span-2">
            <label>Full name <span>*</span></label>
            <input id="fullName" type="text" placeholder="Enter your full name" required />
          </div>

          <!-- User ID (username) -->
          <div class="field">
            <label>User ID (username) <span>*</span></label>
            <input id="userId" type="text" placeholder="choose-your-id" required />
            <div class="hint">This is unique. Two people cannot have the same user ID.</div>
          </div>

          <!-- Phone -->
          <div class="field">
            <label>Phone number <span>*</span></label>
            <input id="phone" type="tel" placeholder="10-digit mobile number" required />
          </div>

          <!-- Email (readonly) -->
          <div class="field col-span-2">
            <label>Email</label>
            <input id="email" type="email" readonly />
            <div class="hint">Email comes from your login and cannot be changed here.</div>
          </div>

          <!-- Address -->
          <div class="field col-span-2">
            <label>Address</label>
            <textarea id="address" placeholder="House no, street, area"></textarea>
          </div>

          <div class="field">
            <label>City</label>
            <input id="city" type="text" placeholder="City" />
          </div>

          <div class="field">
            <label>State</label>
            <input id="state" type="text" placeholder="State" />
          </div>

          <div class="field">
            <label>Pincode</label>
            <input id="pincode" type="text" placeholder="Pincode" />
          </div>

          <!-- Aadhaar -->
          <div class="field">
            <label>Aadhaar number</label>
            <input id="aadhaar" type="text" placeholder="XXXX-XXXX-XXXX (optional)" />
            <div class="hint">Optional. Used for age verification and special offers from admin.</div>
          </div>

          <!-- Job / Study / More -->
          <div class="field">
            <label>Job / work</label>
            <input id="job" type="text" placeholder="What do you work as?" />
          </div>

          <div class="field">
            <label>Study</label>
            <input id="study" type="text" placeholder="School, college or course" />
          </div>

          <div class="field col-span-2">
            <label>More about you</label>
            <textarea id="moreInfo" placeholder="Anything else you want us to know"></textarea>
          </div>
        </form>

        <div class="button-row">
          <button id="saveBtn" class="btn-solid">Save changes</button>
          <button id="cancelBtn" class="btn-outline">Cancel</button>
        </div>

        <div id="statusText" class="status">Fill your details and tap “Save changes”.</div>
      </section>

      <!-- Right info card -->
      <section class="card">
        <div class="side-info">
          <div>
            <div class="side-info-title">Why we ask these details</div>
            <p>We use your profile data to:</p>
            <ul style="padding-left:18px; margin:6px 0;">
              <li>Show your name and user ID inside Solvoro.</li>
              <li>Contact you for orders and support.</li>
              <li>Verify age or eligibility if admin applies special discounts.</li>
            </ul>
          </div>

          <div>
            <div class="side-info-title">Privacy</div>
            <p>Aadhaar and contact details are not visible to other users. They are used only by the Solvoro team.</p>
          </div>

          <div>
            <div class="side-info-title">Quick tips</div>
            <div>
              <span class="pill">Use a clean user ID</span>
              <span class="pill">Add your real phone</span>
              <span class="pill">Keep address updated</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer>
    © <span id="year"></span> Solvoro. All rights reserved.
  </footer>

  <!-- Firebase & edit logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      query,
      where,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbWQgBjAIAn-OI3DzDAqx7lmLmbUCUAWU",
      authDomain: "solvoro-c9155.firebaseapp.com",
      projectId: "solvoro-c9155",
      storageBucket: "solvoro-c9155.firebasestorage.app",
      messagingSenderId: "536457030363",
      appId: "1:536457030363:web:e3315527c15fc037ba3afe",
      measurementId: "G-Z47VFQ3C7Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const yearSpan = document.getElementById("year");
    yearSpan.textContent = new Date().getFullYear().toString();

    const headerAvatar = document.getElementById("headerAvatar");
    const profileAvatar = document.getElementById("profileAvatar");
    const snapName = document.getElementById("snapName");
    const snapMail = document.getElementById("snapMail");

    const fullNameInput = document.getElementById("fullName");
    const userIdInput = document.getElementById("userId");
    const phoneInput = document.getElementById("phone");
    const emailInput = document.getElementById("email");
    const addressInput = document.getElementById("address");
    const cityInput = document.getElementById("city");
    const stateInput = document.getElementById("state");
    const pincodeInput = document.getElementById("pincode");
    const aadhaarInput = document.getElementById("aadhaar");
    const jobInput = document.getElementById("job");
    const studyInput = document.getElementById("study");
    const moreInfoInput = document.getElementById("moreInfo");

    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const statusText = document.getElementById("statusText");

    let currentUser = null;
    let isSaving = false;

    function setAvatarFromEmail(email) {
      if (!email) return;
      const letter = email.trim()[0]?.toUpperCase() || "S";
      headerAvatar.textContent = letter;
      profileAvatar.textContent = letter;
    }

    function setStatus(msg, type = "normal") {
      statusText.textContent = msg;
      statusText.classList.remove("error", "success");
      if (type === "error") statusText.classList.add("error");
      if (type === "success") statusText.classList.add("success");
    }

    cancelBtn.addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "profile.html";
    });

    async function loadProfile(user) {
      snapName.textContent = "Loading...";
      snapMail.textContent = user.email || "";

      try {
        const ref = doc(db, "profiles", user.uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          snapName.textContent = "New user";
          emailInput.value = user.email || "";
          setStatus("Fill your details and tap “Save changes”.");
          return;
        }

        const data = snap.data();
        fullNameInput.value = data.fullName || "";
        userIdInput.value = data.userId || "";
        phoneInput.value = data.phone || "";
        emailInput.value = data.email || user.email || "";
        addressInput.value = data.address || "";
        cityInput.value = data.city || "";
        stateInput.value = data.state || "";
        pincodeInput.value = data.pincode || "";
        aadhaarInput.value = data.aadhaar || "";
        jobInput.value = data.job || "";
        studyInput.value = data.study || "";
        moreInfoInput.value = data.moreInfo || "";

        snapName.textContent = data.fullName || "New user";
        setStatus("You can update any field and save.");
      } catch (err) {
        snapName.textContent = "Profile";
        setStatus("Could not load profile. You can still try to save.", "error");
      }
    }

    async function checkUserIdUnique(userId, currentUid) {
      if (!userId) return false;
      const col = collection(db, "profiles");
      const q = query(col, where("userId", "==", userId));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return true;

      // If found, ensure it belongs to the same user
      if (snapshot.docs.length === 1 && snapshot.docs[0].id === currentUid) {
        return true;
      }
      return false;
    }

    saveBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!currentUser || isSaving) return;

      const fullName = fullNameInput.value.trim();
      const userId = userIdInput.value.trim();
      const phone = phoneInput.value.trim();
      const email = currentUser.email || "";

      if (!fullName || !userId || !phone) {
        setStatus("Full name, user ID and phone number are required.", "error");
        return;
      }

      if (phone.length < 8) {
        setStatus("Please enter a valid phone number.", "error");
        return;
      }

      // Aadhaar simple check (optional)
      const aadhaarRaw = aadhaarInput.value.replace(/\s|-/g, "");
      if (aadhaarRaw && aadhaarRaw.length !== 12) {
        setStatus("If you add Aadhaar, please enter 12 digits (or leave it empty).", "error");
        return;
      }

      isSaving = true;
      saveBtn.disabled = true;
      setStatus("Saving your profile...", "normal");

      try {
        const isUnique = await checkUserIdUnique(userId, currentUser.uid);
        if (!isUnique) {
          setStatus("This user ID is already taken. Please choose another one.", "error");
          isSaving = false;
          saveBtn.disabled = false;
          return;
        }

        const profileRef = doc(db, "profiles", currentUser.uid);
        await setDoc(profileRef, {
          uid: currentUser.uid,
          email,
          fullName,
          userId,
          phone,
          address: addressInput.value.trim(),
          city: cityInput.value.trim(),
          state: stateInput.value.trim(),
          pincode: pincodeInput.value.trim(),
          aadhaar: aadhaarRaw || "",
          job: jobInput.value.trim(),
          study: studyInput.value.trim(),
          moreInfo: moreInfoInput.value.trim(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        setStatus("Profile saved successfully.", "success");
        setTimeout(() => {
          window.location.href = "profile.html";
        }, 700);
      } catch (err) {
        setStatus("Could not save profile. Please try again.", "error");
      } finally {
        isSaving = false;
        saveBtn.disabled = false;
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      setAvatarFromEmail(user.email || "");
      snapMail.textContent = user.email || "";
      emailInput.value = user.email || "";
      loadProfile(user);
    });
  </script>
</body>
</html>
