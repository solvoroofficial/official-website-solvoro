<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solvoro — Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f8f8;
      --card-bg: #ffffff;
      --border: #e2e2e2;
      --text-main: #111111;
      --text-muted: #666666;
      --accent: #111111; /* very little black, mostly grey + white */
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #ffffff, #f5f5f5 60%, #f0f0f0);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ---------- Header (will reuse on homepage) ---------- */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .header-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: linear-gradient(135deg, #fafafa, #eaeaea);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      color: var(--accent);
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      transition: transform 160ms ease, box-shadow 160ms ease;
    }
    .brand-mark:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    .brand-text span:first-child {
      font-size: 16px;
      font-weight: 600;
    }
    .brand-text span:last-child {
      font-size: 12px;
      color: var(--text-muted);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.04);
      background: rgba(255,255,255,0.8);
    }
    .user-chip-name {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 160px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user-avatar-small {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #111111;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    .btn-ghost {
      border-radius: 999px;
      border: 1px solid #dddddd;
      padding: 6px 10px;
      font-size: 12px;
      background: #ffffff;
      cursor: pointer;
      transition: background 140ms ease, transform 120ms ease, box-shadow 120ms ease;
    }
    .btn-ghost:hover {
      background: #f4f4f4;
      transform: translateY(-0.5px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    /* ---------- Main layout ---------- */
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 20px 12px 32px;
    }
    .page-inner {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 18px;
      align-items: flex-start;
      animation: fadeIn 260ms ease-out;
    }
    @media (max-width: 800px) {
      .page-inner {
        grid-template-columns: minmax(0, 1fr);
      }
      .header-inner {
        padding-inline: 12px;
      }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 14px 40px rgba(0,0,0,0.06);
      padding: 18px 18px 20px;
      transition: box-shadow 160ms ease, transform 160ms ease;
    }
    .card:hover {
      box-shadow: 0 18px 48px rgba(0,0,0,0.07);
      transform: translateY(-1px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .card-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    .card-header p {
      margin: 2px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .avatar-large {
      width: 72px;
      height: 72px;
      border-radius: 24px;
      background: #111111;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
      box-shadow: 0 12px 26px rgba(0,0,0,0.3);
      transform-origin: center;
      animation: popIn 260ms ease-out;
    }
    @keyframes popIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .profile-meta {
      margin-bottom: 18px;
    }
    .profile-meta-name {
      font-size: 17px;
      font-weight: 600;
    }
    .profile-meta-email {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .field-group {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 600px) {
      .field-group {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 11px;
      font-size: 14px;
      outline: none;
      background: #fcfcfc;
      transition: border-color 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    input:focus {
      border-color: #bbbbbb;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.03);
      background: #ffffff;
    }
    input[readonly] {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    .btn-primary {
      margin-top: 16px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      background: #111111;
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 140ms ease, transform 120ms ease, box-shadow 120ms ease;
    }
    .btn-primary:hover {
      background: #222222;
      transform: translateY(-0.5px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.18);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #f1f1f1;
      color: #777777;
      margin-top: 4px;
    }

    .side-card {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 12px 32px rgba(0,0,0,0.06);
      padding: 14px 16px 16px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .side-card h3 {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
    }
    .side-list {
      list-style: none;
      padding: 0;
      margin: 6px 0 0;
    }
    .side-list li {
      padding: 4px 0;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111111;
      color: #ffffff;
    }

    .status-text {
      margin-top: 8px;
      font-size: 12px;
    }
    .status-text span {
      font-weight: 500;
      color: #111111;
    }

    .error {
      margin-top: 10px;
      font-size: 13px;
      color: #b3261e;
      display: none;
    }
    .success {
      margin-top: 10px;
      font-size: 13px;
      color: #166534;
      display: none;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(255,255,255,0.9), rgba(240,240,240,0.9));
      z-index: 20;
    }
    .loading-overlay.visible {
      display: flex;
    }
    .spinner {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 2px solid #e0e0e0;
      border-top-color: #111111;
      animation: spin 640ms linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Header (same pattern you can reuse on homepage) -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-mark">S</div>
        <div class="brand-text">
          <span>Solvoro</span>
          <span>Dashboard — Profile</span>
        </div>
      </div>
      <div class="header-right">
        <div class="user-chip" id="headerUserChip" style="display:none;">
          <div class="user-chip-name" id="headerUserName"></div>
          <div class="user-avatar-small" id="headerUserAvatar"></div>
        </div>
        <button class="btn-ghost" id="logoutBtn">Sign out</button>
      </div>
    </div>
  </header>

  <main>
    <div class="page-inner">
      <!-- Main profile card -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Your Profile</h2>
            <p>Only you and Solvoro admins can see this information.</p>
          </div>
          <div class="pill">Profile · editable</div>
        </div>

        <div class="avatar-large" id="bigAvatar">S</div>

        <div class="profile-meta">
          <div class="profile-meta-name" id="displayName">Loading...</div>
          <div class="profile-meta-email" id="displayEmail"></div>
        </div>

        <form id="profileForm">
          <div class="field-group">
            <div>
              <label for="fullName">Full name</label>
              <input id="fullName" type="text" placeholder="Your full name" autocomplete="name" />
            </div>
            <div>
              <label for="phone">Phone (optional)</label>
              <input id="phone" type="tel" placeholder="Phone number" autocomplete="tel" />
            </div>
          </div>

          <div class="field-group">
            <div>
              <label for="dob">Date of birth (optional)</label>
              <input id="dob" type="date" />
            </div>
            <div>
              <label for="aadhaar">Aadhaar Number (optional)</label>
              <input
                id="aadhaar"
                type="text"
                inputmode="numeric"
                maxlength="12"
                placeholder="12-digit Aadhaar"
              />
            </div>
          </div>

          <div class="field-group">
            <div>
              <label for="email">Email (login)</label>
              <input id="email" type="email" readonly />
            </div>
            <div>
              <label for="userId">User ID</label>
              <input id="userId" type="text" readonly />
            </div>
          </div>

          <button type="submit" class="btn-primary" id="saveBtn">
            Save changes
          </button>
          <div class="error" id="errorBox"></div>
          <div class="success" id="successBox">Profile saved.</div>
        </form>
      </section>

      <!-- Right side info card -->
      <aside class="side-card">
        <h3>Account summary</h3>
        <ul class="side-list">
          <li>
            <span>Aadhaar status</span>
            <span id="aadhaarStatusBadge" class="badge">Not added</span>
          </li>
          <li>
            <span>Children discount</span>
            <span id="discountBadge" class="badge">Not applied</span>
          </li>
        </ul>
        <p class="status-text">
          Once your details are complete, Solvoro admins will review them.
          <br />
          If you’re eligible for <span>40% children discount</span>, it will be handled from the admin side.
        </p>
      </aside>
    </div>
  </main>

  <!-- Firebase + Profile logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- Same config as your login page ---
    const firebaseConfig = {
      apiKey: "AIzaSyBbWQgBjAIAn-OI3DzDAqx7lmLmbUCUAWU",
      authDomain: "solvoro-c9155.firebaseapp.com",
      projectId: "solvoro-c9155",
      storageBucket: "solvoro-c9155.firebasestorage.app",
      messagingSenderId: "536457030363",
      appId: "1:536457030363:web:e3315527c15fc037ba3afe",
      measurementId: "G-Z47VFQ3C7Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const loadingOverlay = document.getElementById("loadingOverlay");
    const logoutBtn = document.getElementById("logoutBtn");

    const displayNameEl = document.getElementById("displayName");
    const displayEmailEl = document.getElementById("displayEmail");
    const bigAvatar = document.getElementById("bigAvatar");

    const fullNameInput = document.getElementById("fullName");
    const phoneInput = document.getElementById("phone");
    const dobInput = document.getElementById("dob");
    const aadhaarInput = document.getElementById("aadhaar");
    const emailInput = document.getElementById("email");
    const userIdInput = document.getElementById("userId");
    const profileForm = document.getElementById("profileForm");
    const saveBtn = document.getElementById("saveBtn");

    const errorBox = document.getElementById("errorBox");
    const successBox = document.getElementById("successBox");

    const aadhaarStatusBadge = document.getElementById("aadhaarStatusBadge");
    const discountBadge = document.getElementById("discountBadge");

    const headerUserChip = document.getElementById("headerUserChip");
    const headerUserName = document.getElementById("headerUserName");
    const headerUserAvatar = document.getElementById("headerUserAvatar");

    function setLoading(loading) {
      loadingOverlay.classList.toggle("visible", loading);
      saveBtn.disabled = loading;
    }

    function getInitialLetter(userData) {
      const name = userData.fullName || userData.displayName || userData.email || "S";
      const trimmed = name.trim();
      return trimmed ? trimmed.charAt(0).toUpperCase() : "S";
    }

    function updateBadges(aadhaar) {
      if (aadhaar && aadhaar.trim().length === 12) {
        aadhaarStatusBadge.textContent = "Added";
        aadhaarStatusBadge.style.background = "#111111";
        aadhaarStatusBadge.style.color = "#ffffff";

        discountBadge.textContent = "Under review";
        discountBadge.style.background = "#444444";
      } else if (aadhaar && aadhaar.trim().length > 0) {
        aadhaarStatusBadge.textContent = "Incomplete";
        aadhaarStatusBadge.style.background = "#b3261e";
        aadhaarStatusBadge.style.color = "#ffffff";

        discountBadge.textContent = "Not applied";
        discountBadge.style.background = "#111111";
      } else {
        aadhaarStatusBadge.textContent = "Not added";
        aadhaarStatusBadge.style.background = "#111111";
        discountBadge.textContent = "Not applied";
        discountBadge.style.background = "#111111";
      }
    }

    function showError(msg) {
      if (!msg) {
        errorBox.style.display = "none";
        errorBox.textContent = "";
        return;
      }
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      successBox.style.display = "none";
    }

    function showSuccess(msg) {
      successBox.textContent = msg || "Profile saved.";
      successBox.style.display = "block";
      errorBox.style.display = "none";
    }

    // Auth state
    setLoading(true);
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not logged in -> go back to login page
        window.location.href = "index.html"; // change to your login file if different
        return;
      }

      try {
        // Base info from auth
        const baseProfile = {
          uid: user.uid,
          email: user.email || "",
          displayName: user.displayName || "",
        };

        // Fill header
        headerUserChip.style.display = "flex";
        headerUserName.textContent = baseProfile.email || "User";
        headerUserAvatar.textContent = getInitialLetter({
          fullName: baseProfile.displayName,
          email: baseProfile.email
        });

        // Fill top meta
        displayEmailEl.textContent = baseProfile.email;
        emailInput.value = baseProfile.email;
        userIdInput.value = baseProfile.uid;

        // Load profile from Firestore
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        let profileData = {};

        if (snap.exists()) {
          profileData = snap.data();
        }

        const fullName = profileData.fullName || baseProfile.displayName || "";
        const phone = profileData.phone || "";
        const dob = profileData.dob || "";
        const aadhaar = profileData.aadhaar || "";

        displayNameEl.textContent = fullName || "Your name";
        fullNameInput.value = fullName;
        phoneInput.value = phone;
        dobInput.value = dob;
        aadhaarInput.value = aadhaar;

        const avatarLetter = getInitialLetter({
          fullName: fullName,
          displayName: baseProfile.displayName,
          email: baseProfile.email
        });
        bigAvatar.textContent = avatarLetter;

        updateBadges(aadhaar);
      } catch (err) {
        console.error(err);
        showError("Failed to load profile. Please try again.");
      } finally {
        setLoading(false);
      }
    });

    // Save handler
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      showError("");
      successBox.style.display = "none";
      setLoading(true);

      const fullName = fullNameInput.value.trim();
      const phone = phoneInput.value.trim();
      const dob = dobInput.value;
      const aadhaarRaw = aadhaarInput.value.trim();

      // Simple Aadhaar check, not deep validation
      if (aadhaarRaw && aadhaarRaw.length !== 12) {
        setLoading(false);
        showError("Aadhaar must be exactly 12 digits (or leave empty).");
        return;
      }

      try {
        const userRef = doc(db, "users", user.uid);
        await setDoc(userRef, {
          fullName,
          phone,
          dob,
          aadhaar: aadhaarRaw
        }, { merge: true });

        displayNameEl.textContent = fullName || "Your name";
        bigAvatar.textContent = getInitialLetter({
          fullName,
          email: user.email
        });
        headerUserName.textContent = user.email || fullName || "User";
        headerUserAvatar.textContent = getInitialLetter({
          fullName,
          email: user.email
        });

        updateBadges(aadhaarRaw);
        showSuccess("Profile saved.");
      } catch (err) {
        console.error(err);
        showError("Could not save profile. Please try again.");
      } finally {
        setLoading(false);
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html"; // back to login
    });
  </script>
</body>
</html>
